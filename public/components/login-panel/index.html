<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/input-ripple/input-ripple.html">
<link rel="import" href="../../vendor/urban-icons/urban-icons.html">
<link rel="import" href="../../vendor/urban-login/urban-login.html">
<link rel="import" href="../../vendor/core-ajax/core-ajax.html">

<polymer-element
    name="login-panel"
    attributes="projectName"

    on-keypress="{{onKeypress}}">

    <template>
        <link rel="stylesheet" href="./styles.css" shim-shadowdom>

        <urban-icons></urban-icons>
        <div class="box">
            <h1>{{projectName}}</h1>

            <input-ripple id="user" label="username" center></input-ripple>
            <input-ripple id="pass" label="password" center password></input-ripple>

            <urban-login id="login" label="Login" loadState="true">
                <core-icon icon="urban:loading"></icon>
            </urban-login>

            <core-ajax
                id="xhr"
                auto
                handleAs="json"
                method="POST"
                response="{{res}}"
                on-core-response="{{onAuthSuccess}}"
                on-core-error="{{onAuthFailure}}"></core-ajax>
        </div>
    </template>

    <script charset="utf-8">
        (function() {

            Polymer( 'login-panel', {
                publish: {
                    _username: '',
                    _password: '',
                    projectName: 'Project name',
                    res: null
                },


                ready: function() {
                    console.log( 'login-panel is ready' );

                    this.$.user.addEventListener( 'inputChange', this.onUserChange.bind( this ) );
                    this.$.pass.addEventListener( 'inputChange', this.onPassChange.bind( this ) );
                },

                observe: {
                    '$.login._loading': 'authenticate'
                },


                onKeypress: function( event, detail, sender ) {
                    if ( event.keyCode === 13 && !this.$.login._loading && this.$.login._showing ) {
                        // Now start authentication
                        this.$.login.showLoading();
                    }
                },


                authenticate: function( old, val ) {
                    if ( !val ) return;

                    console.log( 'now attempting authentication' );
                    this.$.xhr.body = {
                        user: this._username,
                        pass: this._password
                    };
                    this.$.xhr.url = 'http://localhost:8008/login';
                },

                onAuthSuccess: function() {
                    console.log( 'on success', this.res );
                },

                onAuthFailure: function() {
                    this.$.login.hideLoading();

                    // TODO: show error hint
                },



                onUserChange: function( event ) {
                    this._username = event.detail;
                    this.doAnim( this.checkDetails() );
                },

                onPassChange: function( event ) {
                    this._password = event.detail;
                    this.doAnim( this.checkDetails() );
                },

                doAnim: function( flag ) {
                    if ( this.$.login._loading ) return;

                    flag ? this.$.login.show() : this.$.login.hide();
                },

                checkDetails: function() {
                    return ( this._username.length && this._password.length );
                }

            });

        })();

    </script>
</polymer-element>
